<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Java Chess</title>
  <style>
    :root{
      --bg:#0e0f12; --panel:#15171c; --accent:#7cb342; --accent-2:#ffc107;
      --text:#e7e9ee; --muted:#9aa0aa; --danger:#e74c3c;
      --light:#ffffff; --dark:#000000;
    }
    *{box-sizing:border-box}
    body { font-family: system-ui, Segoe UI, Arial; margin:0; padding:32px 0 24px 0; background:var(--bg); color:var(--text); display:flex; justify-content:center; min-height:100vh; }
    .page{ width:min(1200px, 95vw); display:flex; flex-direction:column; gap:24px; align-items:stretch }
    header{ display:flex; align-items:center; justify-content:center; gap:16px; margin-bottom:16px; position:sticky; top:0; z-index:5 }
    header h1{ font-size:44px; font-weight:800; margin:0; letter-spacing:0.5px }
    .container{ display:flex; gap:24px; align-items:flex-start; justify-content:center }
    #board-wrap{ position:relative; padding:16px 16px 28px 28px; background:var(--panel); border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.3) }
    #board { display:grid; grid-template-columns: repeat(8, min(11vw,80px)); grid-template-rows: repeat(8, min(11vw,80px)); border:1px solid #222; border-radius:8px; overflow:hidden }
    .sq { width:min(11vw,80px); height:min(11vw,80px); display:flex; align-items:center; justify-content:center; font-weight:600; font-size:min(7vw,36px); cursor:pointer; transition:transform .06s ease; user-select:none }
    .sq:hover{ transform:scale(1.03) }
    .dark { background:var(--dark); } .light { background:var(--light); }
    .sq .wp{ color:#ffffff; text-shadow:0 1px 2px rgba(0,0,0,.5) }
    .sq .bp{ color:#000000; text-shadow:0 1px 0 rgba(255,255,255,.6) }
    .selected { outline:3px solid var(--accent-2); outline-offset:-3px }
    .hint { box-shadow: inset 0 0 0 3px rgba(0,0,0,.15), inset 0 0 0 6px rgba(0,0,0,.08) }
    .last { box-shadow: inset 0 0 0 3px rgba(255,193,7,.6) }
    .coords-x{ position:absolute; left:28px; right:16px; bottom:8px; display:grid; grid-template-columns: repeat(8, min(11vw,80px)); font-size:12px; color:var(--muted) }
    .coords-y{ position:absolute; top:16px; bottom:28px; left:8px; display:grid; grid-template-rows: repeat(8, min(11vw,80px)); font-size:12px; color:var(--muted) }
    .coord-x, .coord-y{ display:flex; align-items:center; justify-content:center }
    #side { min-width:260px; background:var(--panel); border-radius:12px; padding:16px; box-shadow:0 6px 18px rgba(0,0,0,.3) }
    /* status removed */
    .actions{ display:flex; gap:8px; margin-bottom:12px }
    button { padding:10px 14px; border-radius:10px; border:1px solid #2a2d36; background:#1b1d24; color:var(--text); cursor:pointer }
    button.primary{ background:var(--accent); border-color:#5a8f2f; color:#0b1607; font-weight:600 }
    button.danger{ background:#2a1a1a; border-color:#5b2a2a; color:#ffcdc7 }
    .legend{ font-size:12px; color:var(--muted) }
    .scores{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px; }
    .score{ background:#1b1d24; border:1px solid #2a2d36; border-radius:10px; padding:10px; }
    .score h3{ margin:0 0 6px 0; font-size:13px; color:var(--muted) }
    .score .val{ font-size:20px; font-weight:700 }
    .captures{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px }
    .cap{ padding:4px 8px; border-radius:8px; background:#13151a; border:1px dashed #2a2d36; font-size:14px }
    .list{ margin-top:8px; border-top:1px dashed #2b2f3a; padding-top:8px; max-height:200px; overflow:auto }
    .item{ font-size:13px; padding:4px 0; display:flex; justify-content:space-between; color:#cfd3dc }
    footer{ grid-column: 1 / -1; margin-top:auto; color:var(--muted); font-size:12px; }
    @media (max-width:840px){ body{ grid-template-columns: 1fr } .container{ flex-direction:column } }
  </style>
</head>
<body>
  <div class="page">
  <header>
    <h1>Chess Master</h1>
    <div style="display:flex; align-items:center; gap:10px">
      
    </div>
  </header>
  <div class="container">
    <div id="board-wrap"><div id="board"></div><div class="coords-x" id="coordX"></div><div class="coords-y" id="coordY"></div></div>
    <div id="side">
      <div class="actions">
        <button id="reset" class="danger">Reset</button>
        <button id="flip" class="primary">Flip Board</button>
      </div>
      <div class="legend">Tip: Click a piece, then a target square.</div>
      <div class="scores">
        <div class="score" id="scoreW"><h3>White</h3><div class="val">0</div><div class="captures" id="capsW"></div></div>
        <div class="score" id="scoreB"><h3>Black</h3><div class="val">0</div><div class="captures" id="capsB"></div></div>
      </div>
      <div class="list" id="moves"></div>
    </div>
  </div>
  </div>
<script>
let state=null; let sel=null; let flipped=false; let lastMoves=[]; let lastFrom=null; let lastTo=null;
const boardEl = document.getElementById('board');
// status removed

function coordToIdx(r,c){ return r*8+c; }
function idxToCoord(i){ return [Math.floor(i/8), i%8]; }

// Minimal, crisp inline SVGs for each piece (white fill/black fill with contrast strokes)
function svgPiece(code){
  const wStroke = '#222';
  const bStroke = '#ddd';
  const isWhite = code===code.toUpperCase();
  const fill = isWhite ? '#ffffff' : '#000000';
  const stroke = isWhite ? wStroke : bStroke;
  const common = `stroke="${stroke}" stroke-width="2" fill="${fill}"`;
  switch(code){
    case 'P': case 'p':
      return `<svg viewBox='0 0 64 64' width='100%' height='100%'><circle ${common} cx='32' cy='24' r='10'/><rect ${common} x='22' y='34' width='20' height='16' rx='4'/></svg>`;
    case 'N': case 'n':
      return `<svg viewBox='0 0 64 64' width='100%' height='100%'><path ${common} d='M18 46 L30 22 Q37 16 44 20 L40 30 L52 46 Z'/></svg>`;
    case 'B': case 'b':
      return `<svg viewBox='0 0 64 64' width='100%' height='100%'><path ${common} d='M32 14 C24 22,24 30,32 38 C40 30,40 22,32 14 Z'/><rect ${common} x='24' y='40' width='16' height='12' rx='3'/></svg>`;
    case 'R': case 'r':
      return `<svg viewBox='0 0 64 64' width='100%' height='100%'><rect ${common} x='20' y='16' width='24' height='12'/><rect ${common} x='18' y='30' width='28' height='18' rx='3'/></svg>`;
    case 'Q': case 'q':
      return `<svg viewBox='0 0 64 64' width='100%' height='100%'><circle ${common} cx='20' cy='22' r='6'/><circle ${common} cx='44' cy='22' r='6'/><circle ${common} cx='32' cy='16' r='6'/><path ${common} d='M18 34 H46 V46 H18 Z'/></svg>`;
    case 'K': case 'k':
      return `<svg viewBox='0 0 64 64' width='100%' height='100%'><rect ${common} x='28' y='12' width='8' height='12'/><path ${common} d='M20 28 H44 V44 H20 Z'/></svg>`;
    default:
      return '';
  }
}

const VALUES = { 'P':1,'N':3,'B':3,'R':5,'Q':9,'K':0, 'p':1,'n':3,'b':3,'r':5,'q':9,'k':0 };

function render(){
  boardEl.innerHTML='';
  const movesEl = document.getElementById('moves');
  const scoreWEl = document.getElementById('scoreW').querySelector('.val');
  const scoreBEl = document.getElementById('scoreB').querySelector('.val');
  const capsWEl = document.getElementById('capsW');
  const capsBEl = document.getElementById('capsB');
  const coordXEl = document.getElementById('coordX');
  const coordYEl = document.getElementById('coordY');
  for(let vr=0; vr<8; vr++){
    for(let vc=0; vc<8; vc++){
      const r = flipped ? 7 - vr : vr;
      const c = flipped ? 7 - vc : vc;
      const div=document.createElement('div');
      div.className='sq '+(((r+c)%2)?'dark':'light');
      div.dataset.r=r; div.dataset.c=c;
      const v=state.board[r][c];
      const svg = svgPiece(v);
      if(svg){
        const wrap=document.createElement('div');
        wrap.innerHTML=svg;
        const isWhite = v && v !== '.' && v === v.toUpperCase();
        wrap.className = isWhite ? 'wp' : 'bp';
        div.appendChild(wrap);
      }
      if(sel && sel[0]==r && sel[1]==c) div.classList.add('selected');
      if(lastFrom && lastFrom[0]==r && lastFrom[1]==c) div.classList.add('last');
      if(lastTo && lastTo[0]==r && lastTo[1]==c) div.classList.add('last');
      div.addEventListener('click', onSq);
      boardEl.appendChild(div);
    }
  }
  // status removed
  movesEl.innerHTML = lastMoves.map(m=>`<div class="item"><span>${m}</span></div>`).join('');

  // Compute material points and captured pieces
  let w=0,b=0;
  const allPieces=[];
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    const v=state.board[r][c];
    if(!v || v==='.') continue;
    allPieces.push(v);
    if(v===v.toUpperCase()) w+=VALUES[v]; else b+=VALUES[v];
  }
  // Baseline totals at start (White: 39, Black: 39) excluding kings
  const BASE=39;
  // Points: material advantage (captured opponent pieces value minus own captured)
  // Display raw material totals as well
  scoreWEl.textContent = `${w} (${BASE - (b)})`;
  scoreBEl.textContent = `${b} (${BASE - (w)})`;

  // Captures: derive by comparing current pieces to initial counts (approximation)
  const initialCounts = { 'P':8,'N':2,'B':2,'R':2,'Q':1,'K':1, 'p':8,'n':2,'b':2,'r':2,'q':1,'k':1 };
  const curCounts = { 'P':0,'N':0,'B':0,'R':0,'Q':0,'K':0, 'p':0,'n':0,'b':0,'r':0,'q':0,'k':0 };
  allPieces.forEach(v=>{ curCounts[v]++; });
  const capsW=[], capsB=[];
  for(const k of ['p','n','b','r','q']){
    const missing = initialCounts[k] - curCounts[k];
    for(let i=0;i<missing;i++) capsW.push(PIECES[k]);
  }
  for(const k of ['P','N','B','R','Q']){
    const missing = initialCounts[k] - curCounts[k];
    for(let i=0;i<missing;i++) capsB.push(PIECES[k]);
  }
  capsWEl.innerHTML = capsW.map(s=>`<span class="cap">${s}</span>`).join('');
  capsBEl.innerHTML = capsB.map(s=>`<span class="cap">${s}</span>`).join('');
  // Coordinates labels respecting flip state
  coordXEl.innerHTML = '';
  coordYEl.innerHTML = '';
  for(let i=0;i<8;i++){
    const file = String.fromCharCode('A'.charCodeAt(0) + (flipped ? 7-i : i));
    const rank = (flipped ? i+1 : 8-i);
    const fx = document.createElement('div'); fx.className='coord-x'; fx.textContent=file; coordXEl.appendChild(fx);
    const fy = document.createElement('div'); fy.className='coord-y'; fy.textContent=rank; coordYEl.appendChild(fy);
  }
}

async function load(){
  const res = await fetch('/api/state');
  state = await res.json();
  render();
}

function coordToNotation(r,c){ return String.fromCharCode('a'.charCodeAt(0)+c)+(8-r); }

async function move(sr,sc,tr,tc){
  // determine if this is a capture based on current state before posting
  const preTarget = state && state.board ? state.board[tr][tc] : '.';
  const res = await fetch('/api/move', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({sr,sc,tr,tc}) });
  const data = await res.json();
  if(!data.ok) { alert('Illegal move'); sel=null; render(); return; }
  const from = coordToNotation(sr,sc), to = coordToNotation(tr,tc);
  lastFrom = [sr,sc]; lastTo = [tr,tc];
  lastMoves = [ `${from} â†’ ${to}`, ...lastMoves ].slice(0,12);
  state = data.state; sel=null; render();
  // play sound: capture if destination had a piece before move
  // sounds removed
}

function onSq(e){
  const r=Number(e.currentTarget.dataset.r); const c=Number(e.currentTarget.dataset.c);
  if(!sel){ sel=[r,c]; render(); return; }
  const [sr,sc]=sel;
  if(sr===r && sc===c){ sel=null; render(); return; }
  move(sr,sc,r,c);
}

document.getElementById('reset').addEventListener('click', async ()=>{
  await fetch('/api/reset', { method:'POST' });
  // Clear local UI history, last move markers, and selection, then reload and play reset sound
  lastMoves = [];
  lastFrom = null;
  lastTo = null;
  sel = null;
  await load();
  sndReset();
});

document.getElementById('flip').addEventListener('click', ()=>{ flipped=!flipped; render(); });
// sound toggle removed

// dark mode is default; theme toggle removed

load();
</script>
</body>
</html>
